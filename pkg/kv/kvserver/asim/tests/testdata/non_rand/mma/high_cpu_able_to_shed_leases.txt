# See comments on top of high_cpu_able_to_shed_leases.txt for test details.

# Case (2) where s1 has leases and is CPU overloaded due to raft CPU. It
# will be able to shed its own leases because it is the leaseholer. There should
# be a period of lease-rebalancing activity before replica-rebalancing.

gen_cluster nodes=5 node_cpu_rate_capacity=9000000000
----

setting split_queue_enabled=false
----

gen_ranges ranges=25 min_key=0 max_key=10000 placement_type=replica_placement
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6
----
{s1:*,s2,s3}:7
{s1:*,s4,s5}:6
{s1:*,s2,s4}:6
{s1:*,s3,s5}:6

gen_load rate=50000 rw_ratio=0 min_key=0 max_key=10000 raft_cpu_per_write=100000
----

eval duration=30m samples=1 seed=42 cfgs=(mma-only,mma-count) metrics=(cpu,cpu_util,write_bytes_per_second,replicas,leases)
----
cpu#1: last:  [s1=2599713435, s2=2799759450, s3=3200050347, s4=3199885256, s5=3200075310] (stddev=253112601.53, mean=2999896759.60, sum=14999483798)
cpu#1: thrash_pct: [s1=162%, s2=84%, s3=146%, s4=177%, s5=177%]  (sum=746%)
cpu_util#1: last:  [s1=0.29, s2=0.31, s3=0.36, s4=0.36, s5=0.36] (stddev=0.03, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=162%, s2=84%, s3=146%, s4=177%, s5=177%]  (sum=746%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=3, s2=5, s3=7, s4=10, s5=0] (stddev=3.41, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=30%, s2=0%, s3=0%, s4=0%, s5=57%]  (sum=87%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=13, s2=14, s3=16, s4=16, s5=16] (stddev=1.26, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=35%]  (sum=35%)
write_bytes_per_second#1: last:  [s1=25997, s2=27997, s3=32000, s4=31998, s5=32000] (stddev=2530.93, mean=29998.40, sum=149992)
write_bytes_per_second#1: thrash_pct: [s1=162%, s2=84%, s3=146%, s4=177%, s5=177%]  (sum=746%)
artifacts[mma-only]: 123731b2fdd740e2
==========================
cpu#1: last:  [s1=3200054918, s2=2800070997, s3=3200598149, s4=2799968139, s5=3000353068] (stddev=179022817.20, mean=3000209054.20, sum=15001045271)
cpu#1: thrash_pct: [s1=125%, s2=63%, s3=50%, s4=108%, s5=80%]  (sum=426%)
cpu_util#1: last:  [s1=0.36, s2=0.31, s3=0.36, s4=0.31, s5=0.33] (stddev=0.02, mean=0.33, sum=2)
cpu_util#1: thrash_pct: [s1=125%, s2=63%, s3=50%, s4=108%, s5=80%]  (sum=426%)
leases#1: first: [s1=25, s2=0, s3=0, s4=0, s5=0] (stddev=10.00, mean=5.00, sum=25)
leases#1: last:  [s1=6, s2=2, s3=5, s4=5, s5=7] (stddev=1.67, mean=5.00, sum=25)
leases#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
replicas#1: first: [s1=25, s2=13, s3=13, s4=12, s5=12] (stddev=5.02, mean=15.00, sum=75)
replicas#1: last:  [s1=16, s2=14, s3=16, s4=14, s5=15] (stddev=0.89, mean=15.00, sum=75)
replicas#1: thrash_pct: [s1=0%, s2=0%, s3=0%, s4=0%, s5=0%]  (sum=0%)
write_bytes_per_second#1: last:  [s1=32000, s2=28000, s3=32005, s4=27999, s5=30003] (stddev=1790.20, mean=30001.40, sum=150007)
write_bytes_per_second#1: thrash_pct: [s1=124%, s2=63%, s3=50%, s4=108%, s5=80%]  (sum=426%)
artifacts[mma-count]: 2ef4e5947798976f
==========================
